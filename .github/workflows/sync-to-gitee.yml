name: 🚀 Sync Release to Gitee

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  sync-release:
    runs-on: ubuntu-latest
    steps:
    - name: 🧾 Download Release Assets
      uses: dsaltares/fetch-gh-release-asset@v1
      with:
        repo: ${{ github.repository }}
        tag: ${{ github.event.release.tag_name }}
        file: "*"
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: 🗃️ Upload to Gitee
      run: |
        echo "Sync release on Gitee..."
        GITEE_API="https://gitee.com/api/v5/repos/${{ secrets.GITEE_REPO }}/releases"
        
        # 创建 Gitee release
        response=$(curl -s -X POST "$GITEE_API" \
          -H "Content-Type: application/json" \
          -d '{
            "access_token": "${{ secrets.GITEE_TOKEN }}",
            "tag_name": "${{ github.event.release.tag_name }}",
            "name": "${{ github.event.release.name }}",
            "body": "${{ github.event.release.body }}"
          }')

        echo "$response"

        # 提取 Gitee release ID
        release_id=$(echo "$response" | grep -o '"id":[0-9]*' | grep -o '[0-9]*')

        echo "Uploading assets..."
        for asset in *; do
          [ -f "$asset" ] || continue
          echo "Uploading $asset..."
          curl -X POST "https://gitee.com/api/v5/repos/${{ secrets.GITEE_REPO }}/releases/$release_id/assets" \
            -H "Content-Type: multipart/form-data" \
            -F "access_token=${{ secrets.GITEE_TOKEN }}" \
            -F "name=$asset" \
            -F "attachment=@$asset"
        done
