name: ğŸš€ Sync GitHub Release to Gitee

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  sync-release:
    runs-on: ubuntu-latest

    steps:
    - name: ğŸ§° å®‰è£… GitHub CLI
      uses: cli/cli-action@v2

    - name: ğŸ” ç™»å½• GitHub CLI
      run: gh auth setup-git
      env:
        GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“¥ ä¸‹è½½ Release é™„ä»¶
      run: |
        echo "Release tag: ${{ github.event.release.tag_name }}"
        gh release download "${{ github.event.release.tag_name }}" --repo ${{ github.repository }}

    - name: ğŸ“¤ ä¸Šä¼ åˆ° Gitee Release
      run: |
        echo "æ­£åœ¨åŒæ­¥ Release åˆ° Gitee..."
        GITEE_API="https://gitee.com/api/v5/repos/${{ secrets.GITEE_REPO }}/releases"

        # åˆ›å»º Release
        response=$(curl -s -X POST "$GITEE_API" \
          -H "Content-Type: application/json" \
          -d '{
            "access_token": "'${{ secrets.GITEE_TOKEN }}'",
            "tag_name": "'${{ github.event.release.tag_name }}'",
            "name": "'${{ github.event.release.name }}'",
            "body": "'${{ github.event.release.body }}"
          }')

        echo "$response"
        release_id=$(echo "$response" | grep -o '"id":[0-9]*' | grep -o '[0-9]*')

        echo "å¼€å§‹ä¸Šä¼ é™„ä»¶..."
        for asset in *; do
          [ -f "$asset" ] || continue
          echo "ä¸Šä¼  $asset ..."
          curl -X POST "https://gitee.com/api/v5/repos/${{ secrets.GITEE_REPO }}/releases/$release_id/assets" \
            -H "Content-Type: multipart/form-data" \
            -F "access_token=${{ secrets.GITEE_TOKEN }}" \
            -F "name=$asset" \
            -F "attachment=@$asset"
        done
