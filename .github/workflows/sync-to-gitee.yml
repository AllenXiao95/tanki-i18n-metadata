name: üöÄ Sync GitHub Release to Gitee

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  sync-release:
    runs-on: ubuntu-latest

    steps:
    - name: ‚¨áÔ∏è Checkout ‰ªìÂ∫ì‰ª£Á†Å
      uses: actions/checkout@v3

    - name: üîñ Ëé∑ÂèñÊúÄÊñ∞ tagÔºàgithub-tag-actionÔºâ
      id: tag
      uses: anothrNick/github-tag-action@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        WITH_V: true
        DRY_RUN: true

    - name: üßæ ÊâìÂç∞ tag
      run: echo "Latest tag is ${{ steps.tag.outputs.new_tag }}"

    - name: üì• ‰∏ãËΩΩ GitHub Release ÈôÑ‰ª∂
      run: |
        TAG=${{ steps.tag.outputs.new_tag }}
        AUTH_HEADER="Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}"
        GH_API="https://api.github.com/repos/${{ github.repository }}/releases/tags/$TAG"

        echo "üì° ËØ∑Ê±ÇÂú∞ÂùÄ: $GH_API"
        curl -sSL -H "$AUTH_HEADER" "$GH_API" > release.json

        if ! jq -e '.assets' release.json > /dev/null; then
          echo "‚ùå Êó†Ê≥ïËé∑Âèñ Release ÈôÑ‰ª∂‰ø°ÊÅØÔºö"
          cat release.json
          exit 1
        fi

        jq -r '.assets[] | "\(.name) \(.url)"' release.json > assets.txt

        while read -r name url; do
          echo "‚¨áÔ∏è ‰∏ãËΩΩ $name ..."
          curl -L -H "$AUTH_HEADER" -H "Accept: application/octet-stream" "$url" -o "$name"
        done < assets.txt

    - name: üì§ ‰∏ä‰º†Âà∞ Gitee Release
      run: |
        TAG=${{ steps.tag.outputs.new_tag }}
        NAME="Release $TAG"
        BODY="ÂêåÊ≠•Ëá™ GitHub ÁöÑ Release $TAG"
        GITEE_API="https://gitee.com/api/v5/repos/${{ secrets.GITEE_REPO }}/releases"

        echo "üöÄ ÂàõÂª∫ Gitee Release..."
        response=$(curl -s -X POST "$GITEE_API" \
          -H "Content-Type: application/json" \
          -d '{
            "access_token": "'${{ secrets.GITEE_TOKEN }}'",
            "tag_name": "'$TAG'",
            "name": "'$NAME'",
            "body": "'$BODY'"
          }')

        echo "$response"
        release_id=$(echo "$response" | grep -o '"id":[0-9]*' | grep -o '[0-9]*')

        if [ -z "$release_id" ]; then
          echo "‚ùå Gitee Release ÂàõÂª∫Â§±Ë¥•„ÄÇ"
          exit 1
        fi

        echo "üì§ ÂºÄÂßã‰∏ä‰º†ÈôÑ‰ª∂..."
        for file in *; do
          [ -f "$file" ] || continue
          echo "üì§ Ê≠£Âú®‰∏ä‰º† $file Âà∞ Gitee..."
          curl -s -X POST "https://gitee.com/api/v5/repos/${{ secrets.GITEE_REPO }}/releases/$release_id/assets" \
            -H "Content-Type: multipart/form-data" \
            -F "access_token=${{ secrets.GITEE_TOKEN }}" \
            -F "name=$file" \
            -F "attachment=@$file"
        done
