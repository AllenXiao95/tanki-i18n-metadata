name: 🚀 Sync GitHub Release to Gitee

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  sync-release:
    runs-on: ubuntu-latest

    steps:
    - name: 🔑 设置环境变量
      run: |
        echo "REPO=${{ github.repository }}" >> $GITHUB_ENV
        echo "TAG=${{ github.event.release.tag_name }}" >> $GITHUB_ENV
        echo "RELEASE_ID=${{ github.event.release.id }}" >> $GITHUB_ENV

    - name: 📥 使用 curl 下载 Release 附件
      run: |
        echo "下载 Release 附件..."
        GH_API="https://api.github.com/repos/${REPO}/releases/${RELEASE_ID}"
        AUTH_HEADER="Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}"
        curl -sSL -H "$AUTH_HEADER" "$GH_API" | jq -r '.assets[] | "\(.name) \(.url)"' > assets.txt

        while read -r name url; do
          echo "Downloading: $name"
          curl -L -H "$AUTH_HEADER" -H "Accept: application/octet-stream" "$url" -o "$name"
        done < assets.txt

    - name: 📤 上传到 Gitee Release
      run: |
        echo "正在创建 Gitee Release..."
        GITEE_API="https://gitee.com/api/v5/repos/${{ secrets.GITEE_REPO }}/releases"

        response=$(curl -s -X POST "$GITEE_API" \
          -H "Content-Type: application/json" \
          -d '{
            "access_token": "'${{ secrets.GITEE_TOKEN }}'",
            "tag_name": "'${{ env.TAG }}'",
            "name": "'${{ github.event.release.name }}'",
            "body": "'${{ github.event.release.body }}"
          }')

        echo "$response"
        release_id=$(echo "$response" | grep -o '"id":[0-9]*' | grep -o '[0-9]*')

        echo "上传附件到 Gitee..."
        for file in *; do
          [ -f "$file" ] || continue
          echo "Uploading $file..."
          curl -X POST "https://gitee.com/api/v5/repos/${{ secrets.GITEE_REPO }}/releases/$release_id/assets" \
            -H "Content-Type: multipart/form-data" \
            -F "access_token=${{ secrets.GITEE_TOKEN }}" \
            -F "name=$file" \
            -F "attachment=@$file"
        done
