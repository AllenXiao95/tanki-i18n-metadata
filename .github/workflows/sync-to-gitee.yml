name: ğŸš€ Sync GitHub Release to Gitee

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  sync-release:
    runs-on: ubuntu-latest

    steps:
    - name: â± è·å–æœ€æ–° Git Tag
      id: get-latest-tag
      uses: actions-ecosystem/action-get-latest-tag@v1

    - name: ğŸ” æ‰“å° Tag
      run: echo "Latest tag is ${{ steps.get-latest-tag.outputs.tag }}"

    - name: ğŸ“¥ ä¸‹è½½æ‰€æœ‰ Release é™„ä»¶
      uses: dsaltares/fetch-gh-release-asset@v1
      with:
        repo: ${{ github.repository }}
        tag: ${{ steps.get-latest-tag.outputs.tag }}
        file: "*"
        token: ${{ secrets.GITHUB_TOKEN }}

    - name: ğŸ“¤ ä¸Šä¼ åˆ° Gitee Release
      run: |
        TAG=${{ steps.get-latest-tag.outputs.tag }}
        NAME="Release $TAG"
        BODY="åŒæ­¥è‡ª GitHub çš„ Release $TAG"
        GITEE_API="https://gitee.com/api/v5/repos/${{ secrets.GITEE_REPO }}/releases"

        echo "ğŸš€ æ­£åœ¨åˆ›å»º Gitee Release..."
        response=$(curl -s -X POST "$GITEE_API" \
          -H "Content-Type: application/json" \
          -d '{
            "access_token": "'${{ secrets.GITEE_TOKEN }}'",
            "tag_name": "'$TAG'",
            "name": "'$NAME'",
            "body": "'$BODY'"
          }')

        echo "$response"
        release_id=$(echo "$response" | grep -o '"id":[0-9]*' | grep -o '[0-9]*')

        if [ -z "$release_id" ]; then
          echo "âŒ Gitee Release åˆ›å»ºå¤±è´¥ã€‚"
          exit 1
        fi

        echo "ğŸ“¤ å¼€å§‹ä¸Šä¼ é™„ä»¶..."
        for file in *; do
          [ -f "$file" ] || continue
          echo "ğŸ“¤ æ­£åœ¨ä¸Šä¼  $file åˆ° Gitee..."
          curl -s -X POST "https://gitee.com/api/v5/repos/${{ secrets.GITEE_REPO }}/releases/$release_id/assets" \
            -H "Content-Type: multipart/form-data" \
            -F "access_token=${{ secrets.GITEE_TOKEN }}" \
            -F "name=$file" \
            -F "attachment=@$file"
        done
