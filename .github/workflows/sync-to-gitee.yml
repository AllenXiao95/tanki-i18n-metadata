name: üöÄ Sync GitHub Release to Gitee

on:
  release:
    types: [published]
  workflow_dispatch:

jobs:
  sync-release:
    runs-on: ubuntu-latest

    steps:
    - name: ‚¨áÔ∏è Checkout ‰ªìÂ∫ì‰ª£Á†ÅÔºàÂê´ tagÔºâ
      uses: actions/checkout@v3
      with:
        fetch-depth: 0

    - name: üîñ Ëé∑ÂèñÊúÄÊñ∞ tagÔºàactions-ecosystemÔºâ
      id: get-tag
      uses: actions-ecosystem/action-get-latest-tag@v1

    - name: üìå ÂÜôÂÖ• tag Âà∞ÁéØÂ¢ÉÂèòÈáè
      run: echo "LATEST_TAG=${{ steps.get-tag.outputs.tag }}" >> $GITHUB_ENV

    - name: üßæ ÊâìÂç∞ÊúÄÊñ∞ tag
      run: echo "Latest GitHub tag is $LATEST_TAG"

    - name: üì¶ ‰∏ãËΩΩ GitHub Release ÈôÑ‰ª∂
      run: |
        AUTH_HEADER="Authorization: Bearer ${{ secrets.GITHUB_TOKEN }}"
        GH_API="https://api.github.com/repos/${{ github.repository }}/releases/tags/$LATEST_TAG"

        echo "üì° ËØ∑Ê±ÇÂú∞ÂùÄ: $GH_API"
        curl -sSL -H "$AUTH_HEADER" "$GH_API" > release.json

        if ! jq -e '.assets' release.json > /dev/null; then
          echo "‚ùå Êó†Ê≥ïËé∑Âèñ Release ÈôÑ‰ª∂‰ø°ÊÅØÔºö"
          cat release.json
          exit 1
        fi

        jq -r '.assets[] | "\(.name) \(.url)"' release.json > assets.txt

        while read -r name url; do
          echo "‚¨áÔ∏è ‰∏ãËΩΩ $name ..."
          curl -L -H "$AUTH_HEADER" -H "Accept: application/octet-stream" "$url" -o "$name"
        done < assets.txt

    - name: üì§ ‰∏ä‰º†Âà∞ Gitee Release
      run: |
        # 1Ô∏è‚É£ Ê∏ÖÊ¥ó GITEE_REPOÔºåÂéªÈô§ÊâÄÊúâÊç¢Ë°å/ÂõûËΩ¶
        RAW_REPO="${{ secrets.GITEE_REPO }}"
        GITEE_REPO_CLEAN="${RAW_REPO//$'\n'/}"
        GITEE_REPO_CLEAN="${GITEE_REPO_CLEAN//$'\r'/}"

        echo "üß™ CLEAN REPO (hex):"
        echo -n "$GITEE_REPO_CLEAN" | xxd
        echo "üß™ CLEAN REPO (str): [$GITEE_REPO_CLEAN]"

        # 2Ô∏è‚É£ ÂàõÂª∫ Release
        NAME="Release $LATEST_TAG"
        BODY="ÂêåÊ≠•Ëá™ GitHub ÁöÑ Release $LATEST_TAG"
        GITEE_API="https://gitee.com/api/v5/repos/$GITEE_REPO_CLEAN/releases"

        echo "üöÄ ÂàõÂª∫ Gitee Release..."
        response=$(curl -s -X POST "$GITEE_API" \
          -H "Content-Type: application/json" \
          -d "{
            \"access_token\": \"${{ secrets.GITEE_TOKEN }}\",
            \"tag_name\": \"$LATEST_TAG\",
            \"name\": \"$NAME\",
            \"body\": \"$BODY\",
            \"target_commitish\": \"master\"
          }")
        echo "$response"

        # Á≤æÁ°ÆÊèêÂèñ release id
        release_id=$(echo "$response" | jq -r '.id')
        if [ -z "$release_id" ] || [ "$release_id" = "null" ]; then
          echo "‚ùå Gitee Release ÂàõÂª∫Â§±Ë¥•Ôºåinvalid id."
          exit 1
        fi

        # 3Ô∏è‚É£ ‰∏ä‰º†ÈôÑ‰ª∂
        echo "üì§ ÂºÄÂßã‰∏ä‰º†ÈôÑ‰ª∂..."
        for file in *; do
          [ -f "$file" ] || continue
          echo "üì§ ‰∏ä‰º†‰∏≠: $file"

          # URL encode filename
          ENCODED_FILENAME=$(python3 -c "import sys, urllib.parse; print(urllib.parse.quote(sys.argv[1]))" "$file")

          # ÊûÑÂª∫Âπ∂È™åËØÅ URL
          UPLOAD_URL="https://gitee.com/api/v5/repos/$GITEE_REPO_CLEAN/releases/$release_id/assets"
          echo "üîó ‰∏ä‰º†Âú∞ÂùÄ: $UPLOAD_URL"
          python3 -c "import sys; from urllib.parse import urlparse; u=urlparse(sys.argv[1]); assert u.scheme and u.netloc and u.path, f'‚ùå Invalid URL: {sys.argv[1]}'" "$UPLOAD_URL"

          # ÊâßË°å‰∏ä‰º†Âπ∂Ê£ÄÊü•Áä∂ÊÄÅÁ†Å
          http_code=$(curl -w "%{http_code}" -o /tmp/response.json -X POST "$UPLOAD_URL" \
            -H "Content-Type: multipart/form-data" \
            -F "access_token=${{ secrets.GITEE_TOKEN }}" \
            -F "name=$ENCODED_FILENAME" \
            -F "attachment=@$file")

          echo "üîé HTTP Áä∂ÊÄÅÁ†Å: $http_code"
          if [ "$http_code" != "201" ]; then
            echo "‚ùå ‰∏ä‰º† $file Â§±Ë¥•ÔºåÂìçÂ∫îÔºö"
            cat /tmp/response.json
            exit 1
          else
            echo "‚úÖ ‰∏ä‰º†ÊàêÂäü: $file"
          fi
        done
